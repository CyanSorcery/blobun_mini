function gameplay_update()local _is_go=g_intro_anim*g_outro_anim==1g_slime_trail_anim+=.075g_slime_trail_anim%=1g_stage_bg_anim+=.015g_stage_bg_anim%=1if(g_p_intro_cd==45and g_prev_was_gameplay==false)music(setting_get(5)and 0or-1,0,7)g_prev_was_gameplay=true
if g_p_intro_cd<=45and _is_go then if(btn(6))poke(24368,1)
if((g_btn4_press and g_stage_win or btn(6))and count(g_menu)==0)menu_create_puzz()
end g_bottom_msg_anim=mid(0,count(g_menu)==0and(g_stage_win or g_stage_lose)and g_bottom_msg_anim+.2or g_bottom_msg_anim-.2,1)if(_is_go)for _obj in all(g_list_obj)do _obj:onstep()end proc_particles()
local _obj,_lw,_lh=g_list_obj[1],g_p_sst.s_width<<4,g_p_sst.s_height<<4local _anim=_obj.inportal and cos(1-_obj.anim>>2)or _obj.anim g_cam_x=g_p_sst.s_width>8and mid(0,(lerp(_obj.oldx,_obj.x,_anim)<<4)-48,_lw-112)or(_lw>>1)-56g_cam_y=g_p_sst.s_height>7and mid(-8,(lerp(_obj.oldy,_obj.y,_anim)<<4)-48,_lh-108)or(_lh>>1)-60end function gameplay_draw()poke(24405,0)if(g_even_frame)redraw_conveyers()else redraw_waterlava()
if(g_p_updt_zap)redraw_floor_zappers()
if(g_p_updt_coin)redraw_coin_blocks()
redraw_slimetrail()poke(24405,96)palt(0)local _startx,_starty=-32+g_bg_scl,-g_bg_scl if(g_p_i_world>=3)_startx,_starty=-32+-g_cam_x/2,-32+-g_cam_y/2
for _x=_startx,128,32do for _y=_starty,128,32do spr(148,_x,_y,4,2)spr(152,_x,_y+16,4,2)end end poke(24404,96)pal()if(g_p_i_world<=2)for _y=0,127do sspr(0,_y,128,1,sin(g_stage_bg_anim+(_y>>4))*1.4,_y)end
poke(24404,0)camera(g_cam_x,g_cam_y)local _s_w,_s_h=g_p_sst.s_width*2+2,g_p_sst.s_height*2+2palt(256)map(0,0,0,0,_s_w,_s_h,1)do_tile_mirror()map(0,0,-7,0,_s_w,_s_h,128)do_tile_mirror()for _arrow in all(g_list_arrows[g_arrow_index])do _arrow:ondraw()end palt(16384)map(0,0,0,0,_s_w,_s_h,12)palt()map(0,0,0,0,_s_w,_s_h,2)for _obj in all(g_list_obj)do _obj:ondraw()end draw_particles()camera(0,0)local _show_timers,_menus_open=setting_get(1),count(g_menu)local _bott_msg_y,_left_top_bar=lerp(127,115,g_bottom_msg_anim),_show_timers and 0or 87poke(24404,96)pal(g_pal_dark)if _menus_open>0then sspr(0,0,128,128,0,0)else sspr(_left_top_bar,0,128,9,_left_top_bar,0)if(g_bottom_msg_anim>0)sspr(0,_bott_msg_y,128,16,0,_bott_msg_y)
end pal()poke(24404,0)local _col=g_p_time<=g_p_sst.s_goaltime and 7or 13if(g_stage_win and g_p_time<=g_p_sst.s_devtime)_col=10
local _curr_time=dget(g_p_sst.s_saveslot)spr(_curr_time<599.995and 147or 146,88,0)if _show_timers then?format_time(g_p_time),2,2,_col
if(g_p_new_time)draw_wavy_text("new time!",32,2,_col,1.3)
if(_curr_time<=g_p_sst.s_goaltime)?"⧗",81,2,9
if(_curr_time<=g_p_sst.s_devtime)?"♥",75,2,14
end rect(96,1,126,7,7)fillp(g_fillp_diag[ceil(g_fillp_anim)])rectfill(124-max(1,g_list_obj[1].tilestouched/g_tile_count*26),3,124,5,59)fillp()if(g_stage_win or g_stage_lose)draw_wavy_text(g_stage_win and"stage clear!"or"❎ undo",g_stage_win and 42or 50,_bott_msg_y+5,7,1.3)
if(_menus_open==1)local _offset=sin(g_menu[1].m_anim_factor>>2)*-32+-24local _line_x=print_shd("stage "..g_p_i_stage,_offset,106,7,0)line(_offset-2,112,_offset+_line_x,112,7)print_shd(g_p_sst.s_name,_offset,115,7,0)print_shd(g_p_sst.s_author,_offset,122,13,0)
end function redraw_conveyers()local _s="0c38010f00380438080f05380038010f0438113b0f01707f113c0f08113b707f0f0111432438010f00382538080f24380038010f2c3831430f01707f313b0f08313c707f0f01313b"for _b=1,144,12do sspr(subl(_s,_b,1,1),subl(_s,_b+2,1,1),subl(_s,_b+4,1,1),subl(_s,_b+6,1,1),subl(_s,_b+8,1,1),subl(_s,_b+10,1,1))end line(112,127,127,127,7)line(0,56,0,71,0)end function redraw_waterlava()local _sw,_col,_x,_tst1,_tst2=g_shimmer_water,0,0,false,false for i=0,10do _x,_tst1,_tst2=21+i,_sw&1<<i>0,_sw&8<<i>0sset(_x,98,_tst1 and 7or 12)sset(_x,96,_tst2 and 7or 0)sset(_x,92,_tst1 and 9or 4)sset(_x,90,_sw&32<<i>0and 10or 9)sset(_x,88,_tst2 and 10or 0)end for i=0,4do _x,_tst1,_tst2=8+i,_sw&16<<i>0,_sw&64<<i>0sset(_x,98,_tst1 and 7or 12)sset(_x,96,_tst2 and 7or 0)sset(_x,90,_tst1 and 10or 9)sset(_x,88,_tst2 and 10or 0)end for i=0,7do _x,_tst1,_tst2=103-i,95-i,88+i _col=_sw&1<<i>0and 7or 12sset(_x,101,_col)sset(50,103-i,_col)sset(78,96+i,_col)_col=_sw&1<<i>0and 9or 4sset(_x,91,_col)sset(52,_tst1,_col)sset(76,_tst2,_col)_col=_sw&4<<i>0and 9or 10sset(_x,93,_col)sset(50,_tst1,_col)sset(78,_tst2,_col)end g_shimmer_water>><=1end function redraw_slimetrail()local _sta=g_slime_trail_anim spr(224,80,104,6,2)local _dx1,_subt=80for _x=0,32,16do clip(_dx1,104,16,16)for _subx=0,15do _subt=sin(_sta+_subx/8)+104sspr(_x+_subx,112,1,16,_dx1+_subx,_subt)sspr(_dx1,104+_subx,16,1,_dx1,_subt+_subx)end _dx1+=16end local _obj=g_list_obj[1]clip()palt(0,false)spr(208,24,104,3,1)palt()if(_obj.haskey)spr(144,32,104)spr(144,39,104,1,1,true)
for _foffset=0,16,8do _dx1=24+_foffset clip(_dx1,104,8,8)for _subx=0,7do sspr(_subx+_foffset,104,1,8,_dx1+sin(_sta+_subx/8)+_subx,104)end end clip()if(_obj.haskey)spr(145,32,104)spr(145,39,104,1,1,true)
local _eye_determined,_eye_blink,_spr=(btn(4)or _obj.sprint)and _obj.onconvey==false,_obj.blink<4or g_stage_win _spr=_eye_determined and 214or 215if(_eye_blink or g_stage_lose)_spr=216
spr(_spr,g_stage_win and 37or 36,104,1,1,g_stage_win)_spr=_eye_determined and 252or 251if(g_stage_lose)_spr=160
if(g_stage_win)_spr=250
spr(_spr,40,104)for _x=0,23do for _y=0,7do sset(79-_y,104+_x,sget(24+_x,104+_y))end end end g_pal_zappers=str2tbl2d("1d5cdc125848145949",6)function redraw_floor_zappers()local _subt,_o1,_addmod for i=1,3do _addmod=0_o1,_subt=((i+g_p_zap_turn+2+_addmod)%3<<1)+1,g_pal_zappers[i]pal(_subt[3],_subt[_o1])pal(_subt[4],_subt[_o1+1])spr(155+i,96+(i<<3),8,1,2)end pal()g_p_updt_zap=false end function do_tile_mirror()poke(24405,0)camera(0,0)local _dx,_dy for i=0,34do _dx,_dy=(i<<3)%128,(i\16<<4)+8sspr(_dx,_dy,8,16,_dx,_dy,8,16,true)end camera(g_cam_x,g_cam_y)poke(24405,96)end function redraw_coin_blocks()local _coins,_col1,_col2,_ypos=g_list_obj[1].coins for i=0,1do _col1,_col2=4,5if(_coins>i)_col1,_col2=9,4
_ypos=17-i*3for _x=0,8,8do line(72+_x,_ypos,76+_x,_ypos,_col1)line(72+_x,_ypos-1,75+_x,_ypos-1,_col1)_ypos+=1_col1=_col2 end end g_p_updt_coin=false end